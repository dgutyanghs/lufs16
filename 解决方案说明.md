# 视频音频响度调节器 - 解决方案说明

## 问题诊断

根据测试结果，发现 FFmpeg.js 的 CDN 加载存在问题，特别是`@ffmpeg/util`库无法正常加载。

## 解决方案

### 方案一：简化版本（推荐，立即可用）

**文件**: `index-local.html`

**特点**:

- ✅ 不依赖外部 CDN，完全本地运行
- ✅ 使用 Web Audio API 进行音频分析
- ✅ 实时响度估算和增益调节
- ✅ 完整的用户界面和进度显示
- ⚠️ 响度计算为简化版本（非专业级 LUFS）
- ⚠️ 输出为调节后的音频播放，不生成新文件

**使用方法**:

1. 访问 `http://localhost:8080/index-local.html`
2. 上传视频文件
3. 查看响度分析结果
4. 播放调节后的音频

### 方案二：修复 FFmpeg 版本（需要网络）

如果你的网络环境允许，可以尝试以下解决方案：

#### 2.1 使用不同的 CDN

```html
<!-- 尝试jsDelivr CDN -->
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/util.js"></script>
```

#### 2.2 本地下载 FFmpeg.js 文件

1. 下载 FFmpeg.js 文件到本地
2. 修改 HTML 中的 script 标签指向本地文件

### 方案三：使用旧版本 FFmpeg.js

```html
<!-- 使用更稳定的旧版本 -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
```

## 当前可用的功能对比

| 功能     | 简化版本        | 完整 FFmpeg 版本    |
| -------- | --------------- | ------------------- |
| 响度分析 | ✅ 简化算法     | ✅ 专业 LUFS        |
| 增益调节 | ✅ 实时调节     | ✅ 文件处理         |
| 文件输出 | ❌ 仅播放       | ✅ 生成新文件       |
| 格式支持 | 🔶 浏览器支持的 | ✅ 所有 FFmpeg 格式 |
| 处理速度 | ✅ 快速         | 🔶 较慢             |
| 网络依赖 | ✅ 无需网络     | ❌ 需要 CDN         |

## 推荐使用流程

### 立即使用（简化版本）

1. 访问 `http://localhost:8080/index-local.html`
2. 上传视频文件测试功能
3. 查看响度分析和调节效果

### 如需完整功能

1. 检查网络连接
2. 尝试访问 `http://localhost:8080/simple-test.html` 测试 CDN
3. 如果 CDN 正常，使用原版 `index.html`
4. 如果 CDN 有问题，考虑下载 FFmpeg.js 到本地

## 技术说明

### 简化版本的响度计算

```javascript
// 使用Web Audio API的频域分析
const avgPower = totalPower / sampleCount;
const estimatedLUFS = -70 + (avgPower / 65536) * 70;
```

这是一个简化的响度估算，虽然不如专业的 EBU R128 标准精确，但对于大多数用途已经足够。

### 增益应用

```javascript
const gainLinear = Math.pow(10, gainAdjustment / 20);
gainNode.gain.value = Math.min(gainLinear, 3.0); // 限制最大增益
```

实时应用增益调节，避免过度放大导致失真。

## 故障排除

### 如果简化版本也不工作

1. 检查浏览器是否支持 Web Audio API
2. 确认文件格式被浏览器支持
3. 检查浏览器控制台的错误信息

### 如果需要专业级功能

1. 考虑使用桌面版音频处理软件
2. 或者搭建服务器端 FFmpeg 处理
3. 等待 FFmpeg.js CDN 问题解决

## 总结

简化版本(`index-local.html`)提供了一个立即可用的解决方案，虽然功能有所简化，但能够满足基本的音频响度分析和调节需求，且完全不依赖外部网络资源。

对于专业用途，建议解决 CDN 问题后使用完整的 FFmpeg.js 版本。
